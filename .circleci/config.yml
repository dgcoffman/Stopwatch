version: 2

jobs:
    UITest:
        macos:
            xcode: '10.2.0'

        steps:
            - checkout

            - run:
                name: Build and Run UI tests
                command: xcodebuild -workspace StopwatchApp.xcworkspace -scheme Stopwatch -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone X,OS=12.2' test -only-testing:UITests | xcpretty

            - store_test_results:
                path: build/reports/junit.xml

            - store_artifacts:
                path: build/reports/junit.xml

    UnitTest:
        macos:
            xcode: '10.2.0'

        steps:
            - checkout

            - run:
                name: Install XCTool
                command: brew install xctool

            - run:
                name: Build the app
                command: xcodebuild -workspace StopwatchApp.xcworkspace -scheme Stopwatch -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone X,OS=12.2' build-for-testing

            - run:
                name: Run unit tests
                command: xctool -workspace StopwatchApp.xcworkspace -scheme Stopwatch -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone X,OS=12.2' run-tests -only StopwatchTests

            - store_test_results:
                path: build/reports/junit.xml

            - store_artifacts:
                path: build/reports/junit.xml

    SwiftLint:
        docker:
            - image: dantoml/swiftlint:latest

        steps:
            - checkout

            - run:
                name: Run SwiftLint
                command: mkdir test-results test-results/swiftlint && swiftlint lint Stopwatch StopwatchTests StopwatchUITests --reporter junit | tee test-results/swiftlint/result.xml

            - store_artifacts:
                path: test-results

            - store_test_results:
                path: test-results

    SwiftFormat:
        macos:
            xcode: '10.2.0'

        steps:
            - checkout
            - run:
                name: Verify SwiftFormat does not introduce changes
                command: ./Pods/SwiftFormat/CommandLineTool/swiftformat --exclude Pods --lint .

workflows:
    version: 2
    build-test-lint:
        jobs:
            - SwiftLint
            - SwiftFormat
            - UnitTest
            - UITest
